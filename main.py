import telebot
from telebot import types

import json

token = "UNKNOWN_TOKEN"
with open("token.txt") as file:
    token = file.readline().strip('\n')
bot = telebot.TeleBot(token)

with open("questions.json") as file:
    questions = json.load(file)


users_states = {}

def get_next_question_id(user_id) -> int:
    # TODO: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ë–î –∏–ª–∏ —Ñ–∞–π–ª–∞
    return 0

def get_question_by_id(question_id) -> json:
    """
    questions.json format:
    {
        "code": string
        "is_level": bool
        "level": string
        "link": string
        "author": string
    }
    """
    if question_id >= len(questions):
        print("There is no question with id:", question_id)
        return None
    return questions[question_id]

@bot.message_handler(commands=['guess'])
def start_the_game(message):
    bot.send_message(message.from_user.id, '–ü–æ–µ—Ö–∞–ª–∏! üöÄ')

    user_id = message.from_user.id
    question_id = get_next_question_id(user_id)
    question = get_question_by_id(question_id)
    if question == None:
        bot.send_message(user_id, "–í–æ–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å üò¢")
        return

    users_states[user_id] = {
        "question": question,
        "correct_answer": question["level"]
    }

    bot.send_message(message.from_user.id, question["code"])

    levels = ["Junior", "Middle", "Senior", "Lead"]
    years = ["0-1 years", "1-3 years", "3-6 years", "6+ years"]
    if question["is_level"]:
        buttons = [types.KeyboardButton(level) for level in levels]
    else:
        buttons = [types.KeyboardButton(year) for year in years]

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=4)
    markup.add(*buttons)
    bot.send_message(message.from_user.id, "Quess the level!", reply_markup=markup)

@bot.message_handler(content_types=['text'])
def on_message_create(message):

    user_id = message.from_user.id
    state = users_states.get(user_id)

    if state:
        if message.text == state["correct_answer"]:
            bot.send_message(user_id, "–í–µ—Ä–Ω–æ! üéâ\n" + state["question"]["link"] + "\n" + state["question"]["author"])
            users_states[user_id] = None
        else:
            bot.send_message(user_id, "–ù–µ–≤–µ—Ä–Ω–æ ¬Ø\_(„ÉÑ)_/¬Ø. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
    else:
        bot.send_message(user_id, "–ù–∞—á–Ω–∏ –∏–≥—Ä—É, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–∞–Ω–¥—É /guess.")

@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
    bot.send_message(message.from_user.id, "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É Guess the Level! üöÄ\n\n")
    bot.send_message(message.from_user.id, "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –Ω–∞–±–µ—Ä–∏—Ç–µ /guess")

bot.infinity_polling()
